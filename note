#!/bin/bash

YEAR=$(date +'%Y')
MONTH=$(date +'%m')
DAY=$(date +'%d')
NOTE_DIR="$HOME/notes/$YEAR/$MONTH"
NOTE_PATH="$NOTE_DIR/$DAY.md"

NOTERC="$XDG_CONFIG_HOME/note/noterc"
if [ -f "$NOTERC" ]; then source "$XDG_CONFIG_HOME/note/noterc"; fi

create_note() {
    if [ ! -f "$NOTE_PATH" ]; then
        mkdir -p "$NOTE_DIR"
        touch "$NOTE_PATH"
        printf "$day-$month-$year\n---\n\n" >"$NOTE_PATH"
        printf "Created new note: $NOTE_PATH\n"
    else
        printf "Note \"$NOTE_PATH\" already exists. Saving changes to existing file.\n"
    fi
}

print_info() {
    printf "Note preview:\n====================\n\n"
    head -n 8 "$NOTE_PATH"
    printf "\n====================\n"
    printf "Note Stats:\n"
    stat "$NOTE_PATH"
    printf "\n====================\n"
    printf "File Information:\n"
    ls -lah "$NOTE_PATH"
}

print_help() {
    printf "note - Note Keeper 0.3.4 (14 Feb 2019)

Usage: note [arguments]

Arguments:
  -h | --help                         Display usage guide.
  -e | --edit <DATE: year-month-day>  Open a specific note for editing.
  -p | --print                        Print the contents of a note.
  -c | --create                       Create a note but don't open it for editing.
  -i | --info                         Print information about a note.\n"
}

open_note() {
    if [[ $EDITOR = *"vim"* ]] || [[ $EDITOR = *"nvim"* ]]; then
        # Open Vim or Neovim in insert mode.
        $EDITOR "+normal G$" +startinsert! "$NOTE_PATH"
    elif [[ $EDITOR = *"emacs"* ]]; then
        # Open Emacs with cursor at EOF.
        emacs -nw "$NOTE_PATH" --eval "(goto-char (point-max))"
    elif [[ $EDITOR = "" ]]; then
        # If no default editor, use Vim and open in insert mode.
        vim "+normal G$" +startinsert! "$NOTE_PATH"
    else
        $EDITOR "$NOTE_PATH"
    fi
}

if (($# > 0)); then
    while [[ $# -gt 0 ]]; do
        key="$1"
        case $key in
        -e | --edit)
            printf "(e)dit is not yet implemented :(\n"
            #shift
            #shift
            exit 0
            ;;
        -p | --print)
            cat "$NOTE_PATH"
            shift
            ;;
        -c | --create)
            create_note
            shift
            ;;
        -i | --info)
            print_info
            shift
            ;;
        -h | --help)
            print_help
            shift
            ;;
        *)
            printf "Unknown Argument \"$1\"\n"
            printf "Try \"note --help\" to see usage information.\n"
            shift
            ;;
        esac
    done
else
    create_note
    open_note
fi
